<!DOCTYPE html>
<html>
  <head>
    <title>Anaphoric chi-eng</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script src="https://unpkg.com/jspsych@7.0.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.0.0"></script>
    <link href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    var subject_id = jsPsych.randomization.randomID(10);
    
    var filename = `${subject_id}.csv`;

    /* create timeline */
    var timeline = [];

    /* define welcome message trial */
    var welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "歡迎來到這個實驗！請點擊按鈕繼續。",
      choices: ['繼續'],
      margin_vertical: '10px',
      margin_horizontal: '20px',
    };
    timeline.push(welcome);

    /* define instructions */
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>在這個實驗中，屏幕上會出現一個句子。</p>
          <p>句子中會有兩個人物和一個代詞，</p>
          <p>請判斷句子中的代詞指代兩個人物中的哪一個？</p>
          <p>實驗開始前，先完成一道練習題。</p> 
          <p>請點擊按鈕開始</p>`,
        choices: ['繼續'],
        margin_vertical: '10px',
        margin_horizontal: '20px',
    };
    timeline.push(instructions);

    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000,
      data: {
        task: 'fixation'
      }
    };
    timeline.push(fixation);


    /* practice trial */
    var practice_trial = {
      type: jsPsychHtmlButtonResponse, //displays HTML content and records responses generated by button click
      stimulus: '<p><strong>小明看見小華和他的朋友在聊天。</strong></p> <p>句子中"他的朋友"是誰的朋友？</p>', //stimulus: The HTML content to be displayed.
      choices: ['小明', '小華'], //choices: Labels for the buttons.
      margin_vertical: '10px',
      margin_horizontal: '20px',
      data: {
        task: 'practice'
      } //tag data
    };
    timeline.push(practice_trial);

    var transition = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
          <p>練習結束，實驗正式開始。</p> 
          <p>請點擊按鈕繼續</p>
        `,
        choices: ['繼續'],
        margin_vertical: '10px',
        margin_horizontal: '20px',
        post_trial_gap: 1000
    };
    timeline.push(transition);

    var test_stimuli = [
      { stimulus: "<p><strong>小雷看到小偉在和他的朋友聊天。</strong></p> <p>句子中‘他的朋友’是誰的朋友？</p>", selection: ["小雷", "小偉"]},
      { stimulus: "<p><strong>李威碰見阿東在和他的同事說悄悄話。</strong></p> <p>句子中‘他的同事’是誰的同事？</p>", selection: ["李威", "阿東"]},
      { stimulus: "<p><strong>高宇得知張峰在跟他的校友準備比賽。</strong></p> <p>句子中‘他的校友’是誰的校友？</p>", selection: ["高宇", "張峰"]},
    ];

    var fixation1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 1000,
      data: {
        task: 'fixation'
      }
    };

    var test = {
      type: jsPsychHtmlButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: jsPsych.timelineVariable('selection'),
      margin_vertical: '10px',
      margin_horizontal: '20px',
      data: {
        task: 'response'
      }
    }

    var test_procedure = {
      timeline: [fixation1, test],
      timeline_variables: test_stimuli,
      randomize_order: true
    }
    timeline.push(test_procedure);
    
    var test_stimuli = [
      { stimulus: "<p><strong>Ray saw that Will was talking to his friend.</strong></p> <p> To whom does 'his' refer in 'his friend'?</p>", selection: ["Ray", "Will"]},
      { stimulus: "<p><strong>Leo detected that Tony was whispering to his colleague.</strong></p> <p> To whom does 'his' refer in 'his colleague'?</p>", selection: ["Leo", "Tony"]},
      { stimulus: "<p><strong>Gavin learned that Frank was preparing for the competition with his alumni.</strong></p> <p> To whom does 'his' refer in 'his alumni'?</p>", selection: ["Gavin", "Frank"]},
    ];

    var fixation1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 1000,
      data: {
        task: 'fixation'
      }
    };

    var test = {
      type: jsPsychHtmlButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: jsPsych.timelineVariable('selection'),
      margin_vertical: '10px',
      margin_horizontal: '20px',
      data: {
        task: 'response'
      }
    }

    var test_procedure = {
      timeline: [fixation1, test],
      timeline_variables: test_stimuli,
      randomize_order: true
    }
    timeline.push(test_procedure);

    var debrief_block = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        var trials = jsPsych.data.get().filter({task: 'response'});
        var rt = Math.round(trials.select('rt').mean());
        
        return `<p>實驗已完成！</p>
        <p>你的平均作答時間是 ${rt}ms.</p>
        <p>請點擊按鈕結束實驗！感謝你的參與！</p>`;
      },
      choices: ['繼續'],
      margin_vertical: '10px',
      margin_horizontal: '20px',
      post_trial_gap: 1000
    };
    timeline.push(debrief_block);

    var save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "R9A9Km8xGdJo",
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    jsPsych.run(timeline);
  </script>
</html>